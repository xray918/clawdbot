# 🚀 OpenClaw 沙箱性能快速参考

## 📊 一句话总结

**沙箱比主机慢 2-3倍（文件操作），但对 AI 对话服务几乎无影响。**

## ⚡ 核心数据

```
测试场景: 100个1MB文件的完整操作周期

┌─────────────┬──────────┬──────────┬──────────┐
│   操作类型   │   主机   │   沙箱   │ 性能差距 │
├─────────────┼──────────┼──────────┼──────────┤
│ 创建文件     │  0.016s  │  0.064s  │  4.0x ❌ │
│ 读取文件     │  0.008s  │  0.047s  │  5.6x ❌ │
│ 列出目录     │  0.004s  │  0.019s  │  5.2x ❌ │
│ 复制文件     │  0.072s  │  0.118s  │  1.6x ⚠️  │
│ 删除文件     │  0.019s  │  0.022s  │  1.2x ✅ │
├─────────────┼──────────┼──────────┼──────────┤
│ 总耗时       │  0.103s  │  0.284s  │  2.8x ⚠️  │
└─────────────┴──────────┴──────────┴──────────┘
```

## 🎯 实际场景影响

### ✅ 几乎无影响（推荐沙箱）

```bash
场景: AI 对话服务
"帮我解释这段代码"
影响: 0ms ← 无文件操作
用户感知: 无 ✅

场景: 读取单个配置文件
"检查项目配置"
影响: <5ms ← 1-2次文件读取
用户感知: 无 ✅

场景: 生成代码文件
"写一个Python脚本"
影响: <10ms ← 写入1个小文件
用户感知: 无 ✅
```

### ⚠️ 轻微影响（可接受）

```bash
场景: 批量文件处理
"重命名50个文件"
主机: 0.05s | 沙箱: 0.15s
额外耗时: +0.1s ⚠️
用户感知: 可能注意到轻微延迟

场景: 代码仓库操作
"git clone小型仓库"
主机: 1.0s | 沙箱: 2.5s
额外耗时: +1.5s ⚠️
用户感知: 明显变慢但可接受

场景: 目录扫描
"统计代码行数"
主机: 0.2s | 沙箱: 0.5s
额外耗时: +0.3s ⚠️
用户感知: 有延迟但可用
```

### ❌ 显著影响（不推荐沙箱）

```bash
场景: 大规模文件操作
"处理1000个图片"
主机: 2s | 沙箱: 6s
额外耗时: +4s ❌
建议: 使用主机模式

场景: 构建/编译项目
"编译C++项目"
主机: 10s | 沙箱: 25s
额外耗时: +15s ❌
建议: 使用主机模式

场景: 数据库操作
"导入CSV到数据库"
主机: 5s | 沙箱: 15s
额外耗时: +10s ❌
建议: 使用主机模式或优化
```

## 🏆 推荐配置

### 场景 1: 对外 Bot 服务（飞书/Telegram）

```bash
# 配置
mode: "all"           # 全部沙箱
scope: "session"      # 每用户隔离

# 理由
✅ 主要是对话交互，文件操作少
✅ 安全性优先级最高
✅ 0.1-0.2s延迟用户无感知
```

### 场景 2: 内部工具（混合使用）

```bash
# 公开 Agent: 沙箱
mode: "all"

# 管理 Agent: 主机
mode: "off"

# 理由
✅ 根据场景灵活选择
✅ 兼顾安全性和性能
```

### 场景 3: 开发环境

```bash
# 配置
mode: "off"           # 禁用沙箱

# 理由
✅ 开发需要频繁文件操作
✅ 本地环境安全风险低
✅ 最佳性能
```

## 📈 性能瓶颈来源

```
主机模式:
应用 → 文件系统 → 磁盘
开销: 1x (基准)

沙箱模式:
应用 → Docker → overlayfs → 文件系统 → 磁盘
开销: 2-6x

关键因素:
1. Docker 联合文件系统 (overlay2)
2. 容器间通信开销
3. 安全检查 (seccomp/AppArmor)
4. 写时复制 (CoW) 机制
```

## 💡 性能优化技巧

### 1. 使用内存文件系统

```json
{
  "sandbox": {
    "docker": {
      "tmpfs": ["/workspace:rw,size=2g"]
    }
  }
}
```

**提升**: 接近主机性能  
**代价**: 数据重启丢失

### 2. 共享容器模式

```bash
pnpm openclaw config set agents.defaults.sandbox.scope shared
```

**提升**: 减少容器启动开销  
**代价**: 用户间无文件隔离

### 3. 绑定主机目录

```json
{
  "sandbox": {
    "docker": {
      "binds": ["/tmp/workspace:/workspace:rw"]
    }
  }
}
```

**提升**: 主机级别性能  
**代价**: 牺牲部分隔离性

## 🔍 快速测试命令

```bash
# 测试当前沙箱性能
CONTAINER=$(docker ps --filter "name=openclaw-sbx" --format "{{.Names}}" | head -1)

# 写入测试 (100MB)
time docker exec $CONTAINER dd if=/dev/zero of=/workspace/test.dat bs=1M count=100

# 对比主机性能
time dd if=/dev/zero of=/tmp/test.dat bs=1M count=100

# 查看文件系统类型
docker info | grep "Storage Driver"
```

## ❓ 常见问题

### Q: 为什么小文件操作慢5倍，但总体只慢3倍？

A: 因为大部分时间花在大块文件复制上（只慢1.6倍）。小文件操作虽慢，但绝对耗时很短。

### Q: 我应该使用沙箱吗？

A:

- ✅ 对外服务（Bot）→ **强烈推荐**
- ⚠️ 内部工具 → **按需选择**
- ❌ 构建任务 → **不推荐**

### Q: 如何判断性能影响是否可接受？

A: 问自己：

1. 文件操作是否是核心功能？（是 → 考虑主机）
2. 增加0.2秒延迟可接受吗？（是 → 沙箱可用）
3. 安全性有多重要？（很重要 → 优先沙箱）

### Q: 可以同时使用沙箱和主机模式吗？

A: 可以！使用多 Agent 配置：

```json
{
  "agents": {
    "list": [
      {
        "id": "public",
        "sandbox": { "mode": "all" }
      },
      {
        "id": "admin",
        "sandbox": { "mode": "off" }
      }
    ]
  }
}
```

## 📚 更多资源

- **完整性能测试报告**: `sandbox-performance.md`
- **资源占用分析**: `sandbox-resources.md`
- **常用命令**: `cmd.md`
- **官方文档**: `docs/gateway/sandboxing.md`

## 🎯 记住这个

> **对于 AI 对话服务，沙箱性能完全够用。**  
> **0.2秒的延迟 << 安全漏洞的风险**

---

**最后更新**: 2026-02-04  
**测试环境**: macOS Apple Silicon + Docker 29.1.3
